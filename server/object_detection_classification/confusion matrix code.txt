from sklearn.metrics import confusion_matrix

def test_on_testing_set(test_dir, model, columns):
    # Load the model
    model = load_model(model)
    
    # Load test data from CSV file
    test_data = pd.read_csv(test_csv_path)  # Assuming you have a CSV file containing true labels
    
    # Initialize lists to store true labels and predicted labels
    true_labels = []
    predicted_labels = []

    # Iterate through test data and generate predictions
    data_generator = ImageDataGenerator(preprocessing_function=preprocess_input)
    test_generator = data_generator.flow_from_directory(
        test_dir,
        target_size=(224, 224),
        batch_size=1,
        class_mode=None,  # Do not use class labels, as you are doing prediction
        shuffle=False
    )
    for i in range(len(test_generator.filenames)):
        # Generate prediction for each image
        img = next(test_generator)
        prediction = model.predict(img)
        
        # Get true label from test data
        true_label = test_data.loc[test_data['filename'] == os.path.basename(test_generator.filenames[i]), 'true_label'].values[0]
        
        # Map predicted label to class name
        predicted_label = columns[np.argmax(prediction)]
        
        # Append true label and predicted label to lists
        true_labels.append(true_label)
        predicted_labels.append(predicted_label)

    # Return true labels and predicted labels
    return true_labels, predicted_labels

def create_confusion_matrix(true_labels, predicted_labels, classes):
    # Generate confusion matrix using scikit-learn
    confusion_mat = confusion_matrix(true_labels, predicted_labels, labels=classes)
    return confusion_mat

# Usage
true_labels, predicted_labels = test_on_testing_set(test_dir, model, columns)
confusion_mat = create_confusion_matrix(true_labels, predicted_labels, classes)
print("Confusion Matrix:")
print(confusion_mat)
